{"cells":[{"source":"<a href=\"https://www.kaggle.com/code/carlosmorenogarcia/sankey?scriptVersionId=274242978\" target=\"_blank\"><img align=\"left\" alt=\"Kaggle\" title=\"Open in Kaggle\" src=\"https://kaggle.com/static/images/open-in-kaggle.svg\"></a>","metadata":{},"cell_type":"markdown"},{"cell_type":"markdown","id":"0f09f849","metadata":{"papermill":{"duration":0.005011,"end_time":"2025-11-07T12:34:04.515768","exception":false,"start_time":"2025-11-07T12:34:04.510757","status":"completed"},"tags":[]},"source":["# Creating Sankey Diagrams using R\n","\n","* Code source: https://rpubs.com/YJ_Choi/FPDynamicsData\n","* Adding title to Sankeys: https://stackoverflow.com/questions/50132459/how-to-add-title-to-a-networkd3-visualisation-when-saving-as-a-web-page\n"]},{"cell_type":"code","execution_count":1,"id":"77326124","metadata":{"_execution_state":"idle","_uuid":"051d70d956493feee0c6d64651c6a088724dca2a","execution":{"iopub.execute_input":"2025-11-07T12:34:04.528959Z","iopub.status.busy":"2025-11-07T12:34:04.526832Z","iopub.status.idle":"2025-11-07T12:34:05.864173Z","shell.execute_reply":"2025-11-07T12:34:05.862591Z"},"papermill":{"duration":1.346163,"end_time":"2025-11-07T12:34:05.866537","exception":false,"start_time":"2025-11-07T12:34:04.520374","status":"completed"},"tags":[]},"outputs":[{"name":"stderr","output_type":"stream","text":["── \u001b[1mAttaching core tidyverse packages\u001b[22m ──────────────────────── tidyverse 2.0.0 ──\n","\u001b[32m✔\u001b[39m \u001b[34mdplyr    \u001b[39m 1.1.4     \u001b[32m✔\u001b[39m \u001b[34mreadr    \u001b[39m 2.1.5\n","\u001b[32m✔\u001b[39m \u001b[34mforcats  \u001b[39m 1.0.0     \u001b[32m✔\u001b[39m \u001b[34mstringr  \u001b[39m 1.5.1\n","\u001b[32m✔\u001b[39m \u001b[34mggplot2  \u001b[39m 3.5.1     \u001b[32m✔\u001b[39m \u001b[34mtibble   \u001b[39m 3.2.1\n","\u001b[32m✔\u001b[39m \u001b[34mlubridate\u001b[39m 1.9.3     \u001b[32m✔\u001b[39m \u001b[34mtidyr    \u001b[39m 1.3.1\n","\u001b[32m✔\u001b[39m \u001b[34mpurrr    \u001b[39m 1.0.2     \n"]},{"name":"stderr","output_type":"stream","text":["── \u001b[1mConflicts\u001b[22m ────────────────────────────────────────── tidyverse_conflicts() ──\n","\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mfilter()\u001b[39m masks \u001b[34mstats\u001b[39m::filter()\n","\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mlag()\u001b[39m    masks \u001b[34mstats\u001b[39m::lag()\n","\u001b[36mℹ\u001b[39m Use the conflicted package (\u001b[3m\u001b[34m<http://conflicted.r-lib.org/>\u001b[39m\u001b[23m) to force all conflicts to become errors\n"]},{"name":"stderr","output_type":"stream","text":["\n","Attaching package: ‘reshape2’\n","\n","\n"]},{"name":"stderr","output_type":"stream","text":["The following object is masked from ‘package:tidyr’:\n","\n","    smiths\n","\n","\n"]}],"source":["## Load libraries\n","library(tidyverse)\n","library(networkD3)\n","library(reshape2)\n","library(ggplot2)"]},{"cell_type":"code","execution_count":2,"id":"e8a0d03c","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:05.901923Z","iopub.status.busy":"2025-11-07T12:34:05.876867Z","iopub.status.idle":"2025-11-07T12:34:05.937126Z","shell.execute_reply":"2025-11-07T12:34:05.935591Z"},"papermill":{"duration":0.068247,"end_time":"2025-11-07T12:34:05.939208","exception":false,"start_time":"2025-11-07T12:34:05.870961","status":"completed"},"tags":[]},"outputs":[],"source":["## Load data\n","data <- read.csv(\"/kaggle/input/sankey-db-csv/sankey.csv\")"]},{"cell_type":"markdown","id":"21fff957","metadata":{"papermill":{"duration":0.004291,"end_time":"2025-11-07T12:34:05.947933","exception":false,"start_time":"2025-11-07T12:34:05.943642","status":"completed"},"tags":[]},"source":["## Sankey Diagram with Two Columns"]},{"cell_type":"code","execution_count":3,"id":"e8b7950d","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:05.959399Z","iopub.status.busy":"2025-11-07T12:34:05.958097Z","iopub.status.idle":"2025-11-07T12:34:05.971187Z","shell.execute_reply":"2025-11-07T12:34:05.969702Z"},"papermill":{"duration":0.021003,"end_time":"2025-11-07T12:34:05.973193","exception":false,"start_time":"2025-11-07T12:34:05.95219","status":"completed"},"tags":[]},"outputs":[],"source":["## Get unique values from the two columns\n","a=sort(unique(data$Gender))\n","b=sort(unique(data$Household_Income))"]},{"cell_type":"code","execution_count":4,"id":"e7e0e68f","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:05.984709Z","iopub.status.busy":"2025-11-07T12:34:05.983367Z","iopub.status.idle":"2025-11-07T12:34:05.997846Z","shell.execute_reply":"2025-11-07T12:34:05.996385Z"},"papermill":{"duration":0.022448,"end_time":"2025-11-07T12:34:05.999921","exception":false,"start_time":"2025-11-07T12:34:05.977473","status":"completed"},"tags":[]},"outputs":[],"source":["## Create a zeros matrix\n","mat = matrix(0, length(a), length(b))\n","rownames(mat) <- sort(a)\n","colnames(mat) <- sort(b)"]},{"cell_type":"code","execution_count":5,"id":"bde33820","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.011947Z","iopub.status.busy":"2025-11-07T12:34:06.010686Z","iopub.status.idle":"2025-11-07T12:34:06.110084Z","shell.execute_reply":"2025-11-07T12:34:06.10858Z"},"papermill":{"duration":0.107389,"end_time":"2025-11-07T12:34:06.11211","exception":false,"start_time":"2025-11-07T12:34:06.004721","status":"completed"},"tags":[]},"outputs":[],"source":["## Count the number of times one value is related to the other\n","for (x in 1:nrow(data)){\n","    row = data[x,]\n","    m = row$Gender\n","    n = row$Household_Income\n","    if (is.na(m)==FALSE & is.na(n)==FALSE){\n","      mat[m,n]=mat[m,n]+1\n","    }\n","}"]},{"cell_type":"code","execution_count":6,"id":"4da63b3e","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.123715Z","iopub.status.busy":"2025-11-07T12:34:06.122428Z","iopub.status.idle":"2025-11-07T12:34:06.134222Z","shell.execute_reply":"2025-11-07T12:34:06.132696Z"},"papermill":{"duration":0.019709,"end_time":"2025-11-07T12:34:06.136114","exception":false,"start_time":"2025-11-07T12:34:06.116405","status":"completed"},"tags":[]},"outputs":[],"source":["## Convert mat into a data frame (easier to handle)\n","mat=as.data.frame(mat)"]},{"cell_type":"code","execution_count":7,"id":"846a16f1","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.147967Z","iopub.status.busy":"2025-11-07T12:34:06.146559Z","iopub.status.idle":"2025-11-07T12:34:06.177472Z","shell.execute_reply":"2025-11-07T12:34:06.175969Z"},"papermill":{"duration":0.040019,"end_time":"2025-11-07T12:34:06.18035","exception":false,"start_time":"2025-11-07T12:34:06.140331","status":"completed"},"tags":[]},"outputs":[],"source":["## Reshape data to long format\n","data_long <- mat %>%\n","  rownames_to_column %>%\n","  gather(key = 'key', value = 'value', -rowname) %>%\n","  filter(value > 0)\n","colnames(data_long) <- c(\"source\", \"target\", \"value\")"]},{"cell_type":"code","execution_count":8,"id":"b4156f41","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.191844Z","iopub.status.busy":"2025-11-07T12:34:06.190553Z","iopub.status.idle":"2025-11-07T12:34:06.204558Z","shell.execute_reply":"2025-11-07T12:34:06.202744Z"},"papermill":{"duration":0.022901,"end_time":"2025-11-07T12:34:06.207586","exception":false,"start_time":"2025-11-07T12:34:06.184685","status":"completed"},"tags":[]},"outputs":[],"source":["## From these flows we need to create a node data frame:\n","# it lists every entities involved in the flow\n","nodes <- data.frame(name=c(as.character(data_long$source),\n","                           as.character(data_long$target)) %>% unique())"]},{"cell_type":"code","execution_count":9,"id":"c67ce8be","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.21931Z","iopub.status.busy":"2025-11-07T12:34:06.217962Z","iopub.status.idle":"2025-11-07T12:34:06.23246Z","shell.execute_reply":"2025-11-07T12:34:06.230957Z"},"papermill":{"duration":0.023697,"end_time":"2025-11-07T12:34:06.235612","exception":false,"start_time":"2025-11-07T12:34:06.211915","status":"completed"},"tags":[]},"outputs":[],"source":["## With networkD3, connection must be provided using id,\n","# This allows us to know who gets connected\n","# Notice the -1, our IDs will go from 0 to n (JavaScript)\n","data_long$IDsource=match(data_long$source, nodes$name)-1\n","data_long$IDtarget=match(data_long$target, nodes$name)-1"]},{"cell_type":"code","execution_count":10,"id":"0d33c393","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.248189Z","iopub.status.busy":"2025-11-07T12:34:06.246846Z","iopub.status.idle":"2025-11-07T12:34:06.263238Z","shell.execute_reply":"2025-11-07T12:34:06.261763Z"},"papermill":{"duration":0.026358,"end_time":"2025-11-07T12:34:06.266283","exception":false,"start_time":"2025-11-07T12:34:06.239925","status":"completed"},"tags":[]},"outputs":[],"source":["## Make the network\n","# set \"iterations=0\" to avoid automatic assignment of the box order\n","sankey<- sankeyNetwork(Links = data_long, Nodes = nodes,\n","              Source = \"IDsource\", Target = \"IDtarget\",\n","              Value = \"value\", NodeID = \"name\",\n","              sinksRight=FALSE, nodeWidth=40, fontSize=13,\n","              nodePadding=20, iterations=0)"]},{"cell_type":"code","execution_count":11,"id":"94ae90f5","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.278216Z","iopub.status.busy":"2025-11-07T12:34:06.276884Z","iopub.status.idle":"2025-11-07T12:34:06.384108Z","shell.execute_reply":"2025-11-07T12:34:06.382191Z"},"papermill":{"duration":0.115763,"end_time":"2025-11-07T12:34:06.386725","exception":false,"start_time":"2025-11-07T12:34:06.270962","status":"completed"},"tags":[]},"outputs":[{"data":{"text/html":["<iframe src='sankey_plot.html' width='800' height='600'></iframe>"]},"metadata":{},"output_type":"display_data"}],"source":["## Display the HTML widget\n","# This will only work in environments where HTML widgets are supported\n","# (e.g., RStudio or a Jupyter notebook with IRkernel)\n","htmlwidgets::saveWidget(sankey, file = \"sankey_plot.html\", selfcontained = FALSE)\n","IRdisplay::display_html(paste(\"<iframe src='sankey_plot.html' width='800' height='600'></iframe>\"))"]},{"cell_type":"markdown","id":"d24ee375","metadata":{"papermill":{"duration":0.004338,"end_time":"2025-11-07T12:34:06.395522","exception":false,"start_time":"2025-11-07T12:34:06.391184","status":"completed"},"tags":[]},"source":["## Sankey Diagram with Three Columns"]},{"cell_type":"code","execution_count":12,"id":"7c11213b","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.407175Z","iopub.status.busy":"2025-11-07T12:34:06.405854Z","iopub.status.idle":"2025-11-07T12:34:06.41938Z","shell.execute_reply":"2025-11-07T12:34:06.41783Z"},"papermill":{"duration":0.022353,"end_time":"2025-11-07T12:34:06.422183","exception":false,"start_time":"2025-11-07T12:34:06.39983","status":"completed"},"tags":[]},"outputs":[],"source":["## Add a third column\n","c=sort(unique(data$`Would.you.stop.eating.meat.`))"]},{"cell_type":"code","execution_count":13,"id":"9f2732e7","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.433756Z","iopub.status.busy":"2025-11-07T12:34:06.432398Z","iopub.status.idle":"2025-11-07T12:34:06.448129Z","shell.execute_reply":"2025-11-07T12:34:06.446622Z"},"papermill":{"duration":0.024689,"end_time":"2025-11-07T12:34:06.451158","exception":false,"start_time":"2025-11-07T12:34:06.426469","status":"completed"},"tags":[]},"outputs":[],"source":["## Create a new zeros matrix\n","mat2 = matrix(0, length(b), length(c))\n","rownames(mat2) <- b\n","colnames(mat2) <- c"]},{"cell_type":"code","execution_count":14,"id":"65eac972","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.463277Z","iopub.status.busy":"2025-11-07T12:34:06.461944Z","iopub.status.idle":"2025-11-07T12:34:06.551166Z","shell.execute_reply":"2025-11-07T12:34:06.549549Z"},"papermill":{"duration":0.097661,"end_time":"2025-11-07T12:34:06.553442","exception":false,"start_time":"2025-11-07T12:34:06.455781","status":"completed"},"tags":[]},"outputs":[],"source":["## Another count\n","for (x in 1:nrow(data)){\n","    row = data[x,]\n","    m = row$Household_Income\n","    n = row$`Would.you.stop.eating.meat.`\n","    if (is.na(m)==FALSE & is.na(n)==FALSE){\n","      mat2[m,n]=mat2[m,n]+1\n","    }\n","  } "]},{"cell_type":"code","execution_count":15,"id":"80885b44","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.565654Z","iopub.status.busy":"2025-11-07T12:34:06.564016Z","iopub.status.idle":"2025-11-07T12:34:06.576511Z","shell.execute_reply":"2025-11-07T12:34:06.575014Z"},"papermill":{"duration":0.021198,"end_time":"2025-11-07T12:34:06.579109","exception":false,"start_time":"2025-11-07T12:34:06.557911","status":"completed"},"tags":[]},"outputs":[],"source":["## As data frame\n","mat2=as.data.frame(mat2)"]},{"cell_type":"code","execution_count":16,"id":"e9300714","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.591662Z","iopub.status.busy":"2025-11-07T12:34:06.589898Z","iopub.status.idle":"2025-11-07T12:34:06.608865Z","shell.execute_reply":"2025-11-07T12:34:06.607297Z"},"papermill":{"duration":0.02765,"end_time":"2025-11-07T12:34:06.611181","exception":false,"start_time":"2025-11-07T12:34:06.583531","status":"completed"},"tags":[]},"outputs":[],"source":["## Reshape data to long format \n","data_long2 <- mat2 %>%\n","  rownames_to_column %>%\n","  gather(key = 'key', value = 'value', -rowname) %>%\n","  filter(value > 0)\n","colnames(data_long2) <- c(\"source\", \"target\", \"value\")"]},{"cell_type":"code","execution_count":17,"id":"165f9e13","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.623733Z","iopub.status.busy":"2025-11-07T12:34:06.622266Z","iopub.status.idle":"2025-11-07T12:34:06.634516Z","shell.execute_reply":"2025-11-07T12:34:06.633092Z"},"papermill":{"duration":0.021242,"end_time":"2025-11-07T12:34:06.636864","exception":false,"start_time":"2025-11-07T12:34:06.615622","status":"completed"},"tags":[]},"outputs":[],"source":["## Create node data\n","nodes2 <- data.frame(name=c(as.character(data_long2$source),\n","                           as.character(data_long2$target)) %>%unique())"]},{"cell_type":"code","execution_count":18,"id":"7f1650da","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.649134Z","iopub.status.busy":"2025-11-07T12:34:06.647726Z","iopub.status.idle":"2025-11-07T12:34:06.660857Z","shell.execute_reply":"2025-11-07T12:34:06.659416Z"},"papermill":{"duration":0.021487,"end_time":"2025-11-07T12:34:06.662839","exception":false,"start_time":"2025-11-07T12:34:06.641352","status":"completed"},"tags":[]},"outputs":[],"source":["## Source & target\n","data_long2$IDsource=match(data_long2$source, nodes2$name)-1 \n","data_long2$IDtarget=match(data_long2$target, nodes2$name)-1"]},{"cell_type":"code","execution_count":19,"id":"bd4a5e87","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.674591Z","iopub.status.busy":"2025-11-07T12:34:06.673299Z","iopub.status.idle":"2025-11-07T12:34:06.692572Z","shell.execute_reply":"2025-11-07T12:34:06.691113Z"},"papermill":{"duration":0.027289,"end_time":"2025-11-07T12:34:06.694562","exception":false,"start_time":"2025-11-07T12:34:06.667273","status":"completed"},"tags":[]},"outputs":[],"source":["## Make the Three Column Diagram\n","newnodes_col3 <- data.frame(name=c(as.character(data_long2$target)) %>%\n","                               unique())\n","nodes_3cols <-rbind(nodes, newnodes_col3)\n","data_long_3cols <-rbind(data_long, data_long2)\n","# Remove the previous matching\n","data_long_3cols <- subset(data_long_3cols, select = c(\"source\", \"target\", \"value\"))\n","# New matching\n","data_long_3cols$IDsource=match(data_long_3cols$source, nodes_3cols$name)-1\n","data_long_3cols$IDtarget=match(data_long_3cols$target, nodes_3cols$name)-1"]},{"cell_type":"code","execution_count":20,"id":"71587200","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.70629Z","iopub.status.busy":"2025-11-07T12:34:06.704936Z","iopub.status.idle":"2025-11-07T12:34:06.717945Z","shell.execute_reply":"2025-11-07T12:34:06.716075Z"},"papermill":{"duration":0.021368,"end_time":"2025-11-07T12:34:06.720234","exception":false,"start_time":"2025-11-07T12:34:06.698866","status":"completed"},"tags":[]},"outputs":[],"source":["## Make the new network\n","sankey2<- sankeyNetwork(Links = data_long_3cols, Nodes = nodes_3cols,\n","                        Source = \"IDsource\", Target = \"IDtarget\",\n","                        Value = \"value\", NodeID = \"name\", \n","                        sinksRight=FALSE, nodeWidth=40, fontSize=13, \n","                        nodePadding=20, iterations=0)"]},{"cell_type":"code","execution_count":21,"id":"466e88d2","metadata":{"execution":{"iopub.execute_input":"2025-11-07T12:34:06.732423Z","iopub.status.busy":"2025-11-07T12:34:06.731149Z","iopub.status.idle":"2025-11-07T12:34:06.765207Z","shell.execute_reply":"2025-11-07T12:34:06.763624Z"},"papermill":{"duration":0.042456,"end_time":"2025-11-07T12:34:06.767104","exception":false,"start_time":"2025-11-07T12:34:06.724648","status":"completed"},"tags":[]},"outputs":[{"data":{"text/html":["<iframe src='sankey2_plot.html' width='800' height='600'></iframe>"]},"metadata":{},"output_type":"display_data"}],"source":["## Display the HTML widget\n","# This will only work in environments where HTML widgets are supported\n","# (e.g., RStudio or a Jupyter notebook with IRkernel)\n","htmlwidgets::saveWidget(sankey2, file = \"sankey2_plot.html\", selfcontained = FALSE)\n","IRdisplay::display_html(paste(\"<iframe src='sankey2_plot.html' width='800' height='600'></iframe>\"))"]},{"cell_type":"markdown","id":"555211b2","metadata":{"papermill":{"duration":0.004568,"end_time":"2025-11-07T12:34:06.776197","exception":false,"start_time":"2025-11-07T12:34:06.771629","status":"completed"},"tags":[]},"source":["The end"]}],"metadata":{"kaggle":{"accelerator":"none","dataSources":[{"datasetId":6105974,"sourceId":9932871,"sourceType":"datasetVersion"}],"dockerImageVersionId":30749,"isGpuEnabled":false,"isInternetEnabled":true,"language":"r","sourceType":"notebook"},"kernelspec":{"display_name":"R","language":"R","name":"ir"},"language_info":{"codemirror_mode":"r","file_extension":".r","mimetype":"text/x-r-source","name":"R","pygments_lexer":"r","version":"4.4.0"},"papermill":{"default_parameters":{},"duration":5.71536,"end_time":"2025-11-07T12:34:06.901807","environment_variables":{},"exception":null,"input_path":"__notebook__.ipynb","output_path":"__notebook__.ipynb","parameters":{},"start_time":"2025-11-07T12:34:01.186447","version":"2.6.0"}},"nbformat":4,"nbformat_minor":5}